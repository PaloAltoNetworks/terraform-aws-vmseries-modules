# Palo Alto Networks VM-Series NGFW - Centralized Inbound with Load Balancer

## Description

An example usage of Palo Alto's Next Generation Firewall Terraform modules used to spin up an environment in AWS Cloud to protect inbound traffic.

This environment is based on the [Palo Alto's AWS Reference Architecture Guide](https://www.paloaltonetworks.com/resources/guides/intelligent-architectures-aws-reference-architecture). It is built around two VM-Series NGFWs. The setup consists of 2 Virtual Private Clouds:

* Security - hosting the Firewalls and related components:
  * Application and Network Load Balancers in front of
  * 2 independent Next Generation Firewalls.
* Application - hosting an example application:
  * two NGINX servers, SSH enabled, load balanced by
  * internal Network Load Balancer

Both VPCs are connected using a Transit Gateway.

**NOTICE**
Currently all public Load Balancer targets are set up as IP addresses. Keep in mind that if you would like to preserve the source IP for traffic balanced by the Network Load Balancer you would need to:

* use instance IDs instead of IP addresses as targets for NLB
* do a management interface swap: add `mgmt-interface-swap = "enable"` to bootstrap options.

## Usage

Create a `terraform.tfvars` file and copy the content of `example.tfvars` into it. There are options that have to be modified:

* access to public interfaces (FW's management interface and Load Balancers interfaces) is blocked on the Security Group level. To fix this replace the "0.0.0.0/32" address with your own public IP (follow the `<- TODO:` marks)
* uncomment and fill out the `ssh_key_name` property with the name of an AWS Key Pair object holding your public key.

Modifying other properties is optional, although it is highly recommended to change the Host headers value in the Application Load Balancer rules to an FQDN of you choice. This is a list of domain names stored in `host_headers` under `application_lb_rules` property. If you do not have a domain name that could be used you can use the one that will be generated by AWS for the Application Load Balancer. In order to do that provision the environment as it is (see steps below). In the terraform output a property called `lb_fqdn.public_application_load_balancer` will hold the mentioned FQDN. Use it to modify the Host header property in `terraform.tfvars` and re-run `terraform apply`. In this run, terraform will only update the HTTP rule leaving the rest of the infrastructure untouched.

When you are ready to spin up the environment authenticate against AWS with a method of your choice and run the following commands:

```sh
terraform init
terraform apply
terraform output  # optional, this command will give you the terraform output only
```

To connect to the NGFW Web UI you have to set the administrative password. In order to do that connect through SSH to the VM-Series Management interface IP address using the SSH key you provided as the `ssh_key_name` parameter in your `terraform.tfvars` file:

```sh
ssh admin@<mgmt_eip> -i <path_to_your_private_ssh_key>
```

Switch to configuration mode by running:

```sh
configure
```

At this moment you can set the password:

```sh
set mgt-config users admin password
```

You will prompted to provide you password twice. If the password is correct commit your changes and log out.

```sh
commit
```

Now you are ready to configure the Next Generation Firewalls.

## Cleanup

To delete all the resources created by the previous `apply` attempts, execute:

```sh
terraform destroy
```

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 0.13.7, < 2.0.0 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | ~> 3.75 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | ~> 3.75 |

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_app_nlb"></a> [app\_nlb](#module\_app\_nlb) | ../../modules/nlb | n/a |
| <a name="module_app_subnet_sets"></a> [app\_subnet\_sets](#module\_app\_subnet\_sets) | ../../modules/subnet_set | n/a |
| <a name="module_app_transit_gateway_attachment"></a> [app\_transit\_gateway\_attachment](#module\_app\_transit\_gateway\_attachment) | ../../modules/transit_gateway_attachment | n/a |
| <a name="module_app_vpc"></a> [app\_vpc](#module\_app\_vpc) | ../../modules/vpc | n/a |
| <a name="module_app_vpc_routes"></a> [app\_vpc\_routes](#module\_app\_vpc\_routes) | ../../modules/vpc_route | n/a |
| <a name="module_public_alb"></a> [public\_alb](#module\_public\_alb) | ../../modules/alb | n/a |
| <a name="module_public_nlb"></a> [public\_nlb](#module\_public\_nlb) | ../../modules/nlb | n/a |
| <a name="module_security_subnet_sets"></a> [security\_subnet\_sets](#module\_security\_subnet\_sets) | ../../modules/subnet_set | n/a |
| <a name="module_security_transit_gateway_attachment"></a> [security\_transit\_gateway\_attachment](#module\_security\_transit\_gateway\_attachment) | ../../modules/transit_gateway_attachment | n/a |
| <a name="module_security_vpc"></a> [security\_vpc](#module\_security\_vpc) | ../../modules/vpc | n/a |
| <a name="module_security_vpc_routes"></a> [security\_vpc\_routes](#module\_security\_vpc\_routes) | ../../modules/vpc_route | n/a |
| <a name="module_transit_gateway"></a> [transit\_gateway](#module\_transit\_gateway) | ../../modules/transit_gateway | n/a |
| <a name="module_vmseries"></a> [vmseries](#module\_vmseries) | ../../modules/vmseries | n/a |

## Resources

| Name | Type |
|------|------|
| [aws_ec2_transit_gateway_route.from_spokes_to_security](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ec2_transit_gateway_route) | resource |
| [aws_instance.app_vm](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/instance) | resource |
| [aws_ami.bitnami](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ami) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_app_vms"></a> [app\_vms](#input\_app\_vms) | Definition of an exemplary Application VMs. They are based on the latest version of Bitnami's NGINX image.<br><br>The structure of this map is similar to the one defining VMSeries, only one property is supported though: the Availability Zone the VM should be placed in.<br><br>EXAMPLE:<pre>app_vms = {<br>  "appvm01" = { az = "us-east-1b" }<br>  "appvm02" = { az = "us-east-1a" }<br>}</pre> | `map(any)` | n/a | yes |
| <a name="input_app_vpc_cidr"></a> [app\_vpc\_cidr](#input\_app\_vpc\_cidr) | Address range for the application VPC. | `string` | `"10.200.0.0/16"` | no |
| <a name="input_app_vpc_name"></a> [app\_vpc\_name](#input\_app\_vpc\_name) | Name of the VPC used for deploying applications. | `string` | `"app-vpc"` | no |
| <a name="input_app_vpc_security_groups"></a> [app\_vpc\_security\_groups](#input\_app\_vpc\_security\_groups) | Definition of Security Groups used in Application VPC. For details and example see `security_vpc_security_groups` details. | `any` | n/a | yes |
| <a name="input_app_vpc_subnets"></a> [app\_vpc\_subnets](#input\_app\_vpc\_subnets) | A map containing configuration of all Application VPC subnets. For details refer to `security_vpc_subnets` description. | `map(any)` | n/a | yes |
| <a name="input_app_vpc_tgw_attachment_name"></a> [app\_vpc\_tgw\_attachment\_name](#input\_app\_vpc\_tgw\_attachment\_name) | A name of a TGW attachment in the application VPC. | `string` | `"app-tgw-attachment"` | no |
| <a name="input_application_lb_name"></a> [application\_lb\_name](#input\_application\_lb\_name) | Name of the public Application Load Balancer placed in front of the Firewalls' public interfaces. | `string` | `"public-alb"` | no |
| <a name="input_application_lb_rules"></a> [application\_lb\_rules](#input\_application\_lb\_rules) | A map of rules for the Application Load Balancer. See [modules documentation](../../modules/alb/README.md) for details. | `any` | n/a | yes |
| <a name="input_bootstrap_options"></a> [bootstrap\_options](#input\_bootstrap\_options) | A string representing bootstrap options. For details refer to [Palo Alto documentation](https://docs.paloaltonetworks.com/vm-series/10-2/vm-series-deployment/bootstrap-the-vm-series-firewall/bootstrap-the-vm-series-firewall-in-aws). | `string` | n/a | yes |
| <a name="input_global_tags"></a> [global\_tags](#input\_global\_tags) | Tags to add to all AWS objects. | `map(string)` | `{}` | no |
| <a name="input_internal_app_nlb_name"></a> [internal\_app\_nlb\_name](#input\_internal\_app\_nlb\_name) | Name of the internal Network Load Balancer placed in front of the application VMs. | `string` | `"int-app-nlb"` | no |
| <a name="input_internal_app_nlb_rules"></a> [internal\_app\_nlb\_rules](#input\_internal\_app\_nlb\_rules) | A set of rules for the Network Load Balancer placed in front of the Application VMs. See [modules documentation](../../modules/nlb/README.md) for details.<br><br>Just like in case of the `network_lb_rules`, `targets` and `target_type` properties are omitted because they are the same for all rules. In this module's use case the type is `instance` and instance IDs are calculated dynamically. Just like in case of the public Network Load Balancer, rules and targets are *combined* in `locals` section of the `applicaton.tf`. | `any` | n/a | yes |
| <a name="input_name_prefix"></a> [name\_prefix](#input\_name\_prefix) | A prefix to add to all AWS object names. | `string` | `"example-"` | no |
| <a name="input_network_lb_name"></a> [network\_lb\_name](#input\_network\_lb\_name) | Name of the public Network Load Balancer placed in front of the Firewalls' public interfaces. | `string` | `"public-nlb"` | no |
| <a name="input_network_lb_rules"></a> [network\_lb\_rules](#input\_network\_lb\_rules) | A map of rules for the public Network Load Balancer. See [modules documentation](../../modules/nlb/README.md) for details.<br><br>NOTICE. In this example we skip the `target_type` and `targets` properties, as this is a public Load Balancer in front of Firewall's public interfaces.<br>The target type will be always `ip` and the `targets` - a map of Firewall's public interface private IP addresses. <br>The targets are *combined* with rules in `locals` section in `main.tf`. | `any` | n/a | yes |
| <a name="input_region"></a> [region](#input\_region) | AWS region used to deploy the resources. | `string` | `"us-east-1"` | no |
| <a name="input_security_vpc_cidr"></a> [security\_vpc\_cidr](#input\_security\_vpc\_cidr) | Address range for the security VPC. | `string` | `"10.100.0.0/16"` | no |
| <a name="input_security_vpc_name"></a> [security\_vpc\_name](#input\_security\_vpc\_name) | Name of the VPC used for deploying Firewalls. | `string` | `"security-vpc"` | no |
| <a name="input_security_vpc_security_groups"></a> [security\_vpc\_security\_groups](#input\_security\_vpc\_security\_groups) | A map containing a definition of all security groups for the Security VPC.<br><br>EXAMPLE:<pre>security_vpc_security_groups = {<br>  untrust = {<br>    name = "untrust-security-group"<br>    rules = {<br>      all_inbound = {<br>        description = "Permit all incoming traffic"<br>        type        = "ingress", from_port = "0", to_port = "0", protocol = "ALL"<br>        cidr_blocks = ["0.0.0.0/0"]<br>      }<br>      fw_traffic = {<br>        description = "Permit all outgoing traffic"<br>        type        = "egress", from_port = "0", to_port = "0", protocol = "ALL"<br>        cidr_blocks = ["0.0.0.0/0"]<br>      }<br>    }<br>  }<br>}</pre> | `any` | n/a | yes |
| <a name="input_security_vpc_subnets"></a> [security\_vpc\_subnets](#input\_security\_vpc\_subnets) | Definition of all subnets in the security VPC.<br><br>This is a map where key is the subnet's CIDR and value contains a map consisting of the Availability Zone (in which the subnet will be created) and the subnet set name. <br><br>The latter is used to identify a purpose of the subnet, for example: management, trust, tgw, etc. This property is used later on in the code to reference all subnets of the same type/purpose.<br><br>EXAMPLE:<pre>security_vpc_subnets = {<br>  "10.0.0.0/24" = {<br>    az = "us-east-1a"<br>    set = "management"<br>  }<br>}</pre> | `map(any)` | n/a | yes |
| <a name="input_security_vpc_tgw_attachment_name"></a> [security\_vpc\_tgw\_attachment\_name](#input\_security\_vpc\_tgw\_attachment\_name) | A name of a TGW attachment in the security VPC. | `string` | `"security-tgw-attachment"` | no |
| <a name="input_ssh_key_name"></a> [ssh\_key\_name](#input\_ssh\_key\_name) | A name of an existing AWS Key Pair object holding you SSH public key in AWS region of choice. | `string` | n/a | yes |
| <a name="input_transit_gateway_asn"></a> [transit\_gateway\_asn](#input\_transit\_gateway\_asn) | Private Autonomous System Number (ASN) of the Transit Gateway for the Amazon side of a BGP session.<br>The range is 64512 to 65534 for 16-bit ASNs and 4200000000 to 4294967294 for 32-bit ASNs. | `number` | `"65200"` | no |
| <a name="input_transit_gateway_name"></a> [transit\_gateway\_name](#input\_transit\_gateway\_name) | The name of the created Transit Gateway. | `string` | `"tgw"` | no |
| <a name="input_transit_gateway_route_tables"></a> [transit\_gateway\_route\_tables](#input\_transit\_gateway\_route\_tables) | Complex input with the Route Tables of the Transit Gateway. Example:<pre>{<br>  "from_security_vpc" = {<br>    create = true<br>    name   = "myrt1"<br>  }<br>  "from_spoke_vpc" = {<br>    create = true<br>    name   = "myrt2"<br>  }<br>}</pre>Two keys are required:<br><br>- from\_security\_vpc describes which route table routes the traffic coming from the Security VPC,<br>- from\_spoke\_vpc describes which route table routes the traffic coming from the Spoke (App1) VPC.<br><br>Each of these entries can specify `create = true` which creates a new RT with a `name`.<br>With `create = false` the pre-existing RT named `name` is used. | `any` | n/a | yes |
| <a name="input_vmseries"></a> [vmseries](#input\_vmseries) | Definition of VMSeries VMs. Please refer to [VMSeries module](../../modules/vmseries/README.md) for details | `any` | n/a | yes |
| <a name="input_vmseries_version"></a> [vmseries\_version](#input\_vmseries\_version) | Version of the VMSeries firewall. Please verify if the version you require is available in your region of choice. | `string` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_app_vm_ips"></a> [app\_vm\_ips](#output\_app\_vm\_ips) | A map private IP addresses assigned to Application VMs. |
| <a name="output_fw_public_ips"></a> [fw\_public\_ips](#output\_fw\_public\_ips) | A map of Firewalls' public IPs. |
| <a name="output_lb_fqdns"></a> [lb\_fqdns](#output\_lb\_fqdns) | Fully Qualified Domain Names for all Load Balancers. |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
